openapi: 3.0.3
info:
  title: Example API
  version: 1.0.0
servers:
  - url: http://127.0.0.1:8000/api

paths:
  /withdraw:
    post:
      tags: [ Balance ]
      operationId: withdraw
      summary: Списание средств с баланса пользователя
      description: >
        Списание средств с баланса пользователя.
      requestBody:
        required: true
        description: Данные для списания средств
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WithdrawRequest'
            examples:
              valid:
                summary: Корректный пример
                value:
                  amount: 100.00
                  comment: "Оплата услуги"
      responses:
        '200':
          description: OK — средства успешно списаны
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WithdrawResponse'
        '400':
          description: Validation Error — входные данные не прошли валидацию.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized — пользователь не аутентифицирован.
        '409':
          description: Conflict — не достаточно средств .
        '419':
          description: CSRF Token Mismatch
        '500':
          description: Internal Server Error — непредвиденная ошибка на сервере.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - cookieAuth: []
          xsrfHeader: []

  /deposit:
    post:
      tags: [ Balance ]
      operationId: deposit
      summary: Пополнение баланса пользователя
      description: >
        Зачисление средств на баланс пользователя.
      requestBody:
        required: true
        description: Данные для пополнения баланса
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DepositRequest'
            examples:
              valid:
                summary: Корректный пример
                value:
                  amount: 500.00
      responses:
        '200':
          description: OK — средства успешно зачислены
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DepositResponse'
        '400':
          description: Validation Error — входные данные не прошли валидацию.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized — пользователь не аутентифицирован.
        '419':
          description: CSRF Token Mismatch
        '500':
          description: Internal Server Error — непредвиденная ошибка на сервере.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - cookieAuth: []
          xsrfHeader: []

  /balance/{userID}:
    get:
      tags: [ Balance ]
      operationId: getBalance
      summary: Баланс пользователя.
      description: >
        Получить баланс пользователя.
      parameters:
        - name: userID
          in: path
          required: true
          description: Идентификатор пользователя
          schema:
            type: integer
          example: 1
      responses:
        '200':
          description: OK — баланс получен.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BalanceResponse'
        '403':
          description: Forbidden — нет доступа.
        '404':
          description: Not Found — пользователь не найден.
        '419':
          description: CSRF Token Mismatch — отсутствует или неверный `X-XSRF-TOKEN`/cookie.
        '500':
          description: Internal Server Error — непредвиденная ошибка на сервере.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - cookieAuth: []
          xsrfHeader: []

  /auth/users:
    post:
      tags: [ Auth ]
      operationId: registerUser
      summary: Регистрация нового пользователя (Sanctum SPA)
      description: >
        Создаёт учётную запись и аутентифицирует пользователя сессией.
      requestBody:
        required: true
        description: Тело запроса с учётными данными.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterUser'
            examples:
              valid:
                summary: Корректный пример
                value:
                  name: "new_user_01"
      responses:
        '201':
          description: Created — пользователь создан и аутентифицирован сессией.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegisterResponse'
              examples:
                created:
                  summary: Успешная регистрация
                  value:
                    user:
                      id: 1
                      name: "new_user_01"
        '400':
          description: Validation Error — входные данные не прошли валидацию.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '419':
          description: CSRF Token Mismatch — отсутствует или неверный `X-XSRF-TOKEN`/cookie.
        '500':
          description: Internal Server Error — непредвиденная ошибка на сервере.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/login:
    post:
      tags: [ Auth ]
      operationId: loginUser
      x-lg-middleware:
        - web
      summary: Вход пользователя (Sanctum SPA)
      description: >
        Аутентифицирует существующего пользователя и устанавливает cookie-сессию.
      requestBody:
        required: true
        description: Учетные данные пользователя.
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginUser'
            examples:
              valid:
                summary: Корректный пример
                value:
                  name: "new_user_01"
      responses:
        '200':
          description: OK — пользователь успешно аутентифицирован, cookie-сессия установлена.
        '400':
          description: Validation Error — входные данные не прошли валидацию.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              examples:
                bad:
                  value:
                    errors:
                      - field: name
                        message: "Имя обязательно."
        '419':
          description: CSRF Token Mismatch — отсутствует или неверный `X-XSRF-TOKEN`/cookie.
        '429':
          description: Too Many Requests — превышен лимит попыток входа (если включён троттлинг).
        '500':
          description: Internal Server Error — непредвиденная ошибка на сервере.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - xsrfHeader: []

components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: laravel_session
      description: >
        Сессионная cookie Laravel (`laravel_session`). Устанавливается фреймворком.
        Используется для stateful-аутентификации в SPA-потоке Sanctum.
    xsrfHeader:
      type: apiKey
      in: header
      name: X-XSRF-TOKEN
      description: >
        CSRF-токен, который должен совпадать со значением cookie `XSRF-TOKEN`
        (после URL-decode). Обычно выставляется клиентом автоматически (например, Axios).

  schemas:
    RegisterUser:
      type: object
      description: Тело запроса для регистрации нового пользователя.
      required: [ name ]
      properties:
        name:
          type: string
          minLength: 6
          maxLength: 255
          description: >
            Имя пользователя (логин). Минимум 6, максимум 255 символов. Должно быть уникальным.
          example: "new_user_01"

    RegisterResponse:
      type: object
      description: Ответ после успешной регистрации (без токена; аутентификация по cookie-сессии).
      required: [ user ]
      properties:
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      description: Базовая модель пользователя.
      required: [ id, name ]
      properties:
        id:
          type: integer
          description: Уникальный идентификатор пользователя (int).
          example: 1
        name:
          type: string
          description: Уникальное имя пользователя (логин).
          example: "new_user_01"

    DepositRequest:
      type: object
      description: Запрос на пополнение баланса
      required: [ amount ]
      properties:
        amount:
          type: number
          format: float
          minimum: 0.01
          description: Сумма пополнения
          example: 500.00

    DepositResponse:
      type: object
      description: Ответ после успешного пополнения
      required: [ user_id, balance, amount, message ]
      properties:
        user_id:
          type: integer
          example: 1
        balance:
          type: number
          format: float
          description: Текущий баланс после операции
          example: 500.00
        amount:
          type: number
          format: float
          description: Сумма пополнения
          example: 500.00
        message:
          type: string
          example: "Баланс успешно пополнен"

    WithdrawRequest:
      type: object
      description: Запрос на списание средств
      required: [ amount ]
      properties:
        amount:
          type: number
          format: float
          minimum: 0.01
          description: Сумма списания
          example: 100.00
        comment:
          type: string
          maxLength: 255
          description: Комментарий к списанию
          example: "Оплата услуги"

    WithdrawResponse:
      type: object
      description: Ответ после успешного списания
      required: [ user_id, balance, amount, message ]
      properties:
        user_id:
          type: integer
          example: 1
        balance:
          type: number
          format: float
          description: Текущий баланс после операции
          example: 400.00
        amount:
          type: number
          format: float
          description: Сумма списания
          example: 100.00
        message:
          type: string
          example: "Средства успешно списаны"

    BalanceResponse:
      type: object
      description: Модель баланса.
      required: [user_id, balance]
      properties:
        user_id:
          type: integer
          example: 1
        balance:
          type: number
          format: float
          example: 350.00

    ValidationError:
      type: object
      description: Стандартизированный формат ошибки.
      properties:
        message:
          type: string
          nullable: true
          description: Общее сообщение об ошибке. Обычно приходит или оно или errors.
        errors:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ValidationErrorItem'
    ValidationErrorItem:
      type: object
      required: [ message ]
      properties:
        message:
          type: string
          description: Человеческое описание проблемы.
          example: "Имя должно быть не короче 6 символов."
        field:
          type: string
          description: Имя поля, к которому относится ошибка.
          example: name

    Error:
      type: object
      required: [ message ]
      properties:
        message:
          type: string
          description: Человеческое описание проблемы.
          example: "Что то пошло не так."

    LoginUser:
      type: object
      description: Тело запроса для входа пользователя.
      required: [ name ]
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 255
          description: Имя пользователя (логин).
          example: "new_user_01"
